<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR自動生成</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; }
    .wrap { max-width: 760px; margin: 0 auto; }
    #qrcode { margin-top: 16px; }
    .meta { color:#555; font-size:14px; margin-top:10px; word-break: break-all; }
    .error { color:#b00020; margin-top:12px; }
    button { margin-top: 12px; padding: 8px 12px; }
    canvas { border:1px solid #ddd; border-radius: 8px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef; color:#224; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>QRコード <span class="badge">自動生成</span></h1>
    <div id="qrcode"></div>
    <div class="meta" id="info"></div>
    <button id="download" style="display:none;">PNGでダウンロード</button>
    <div class="error" id="err"></div>
  </div>

  <!-- QR生成ライブラリ（バージョン固定推奨） -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.js"></script>

  <script>
    const params = new URLSearchParams(location.search);

    // ===== 設定（社外公開向け）=====
    const MAX_LEN = 2000;                 // 入力長上限
    const MIN_SIZE = 64, MAX_SIZE = 1024; // サイズ上限
    const ALLOW_URL = true;               // url= を許可するか
    const URL_ALLOWLIST = [
      // 例: 自社ドメインだけ許可したい場合に入れる
      // "example.com",
      // "www.example.com"
    ];
    // ================================

    const qrcodeEl = document.getElementById("qrcode");
    const infoEl = document.getElementById("info");
    const errEl = document.getElementById("err");
    const dlBtn = document.getElementById("download");

    const size = Math.min(Math.max(parseInt(params.get("size") || "256", 10), MIN_SIZE), MAX_SIZE);
    const ecc = (params.get("ecc") || "M").toUpperCase();
    const eccMap = { L:"L", M:"M", Q:"Q", H:"H" };
    const level = eccMap[ecc] || "M";

    // 優先: url > text（用途に合わせて入れ替えOK）
    const rawUrl = params.get("url");
    const rawText = params.get("text") ?? params.get("data") ?? "";

    let payload = "";
    let mode = "";

    function fail(msg) {
      errEl.textContent = msg;
      infoEl.textContent = "";
      throw new Error(msg);
    }

    // url= の扱い（社外公開なら制限推奨）
    if (rawUrl && ALLOW_URL) {
      let u;
      try { u = new URL(rawUrl); } catch { fail("url= がURLとして不正です。"); }

      // http/https のみ許可（javascript: 等を拒否）
      if (!(u.protocol === "http:" || u.protocol === "https:")) {
        fail("url= は http/https のみ許可しています。");
      }

      // allowlist が設定されていればホストを制限
      if (URL_ALLOWLIST.length > 0 && !URL_ALLOWLIST.includes(u.hostname)) {
        fail("このドメインは許可されていません。");
      }

      payload = u.toString();
      mode = "url";
    } else if (rawText) {
      payload = rawText;
      mode = "text";
    } else {
      fail("パラメータがありません。例: ?text=Hello  または ?url=https%3A%2F%2Fexample.com");
    }

    if (payload.length > MAX_LEN) fail(`データが長すぎます（上限 ${MAX_LEN} 文字）。`);

    // 画面に必ず内容を表示（スキャン前に確認できる）
    infoEl.textContent = `mode=${mode} / size=${size} / ecc=${level} / 内容: ${payload}`;

    // 生成
    const canvas = document.createElement("canvas");
    qrcodeEl.replaceChildren(canvas);

    QRCode.toCanvas(canvas, payload, { width: size, margin: 2, errorCorrectionLevel: level }, (error) => {
      if (error) fail("QR生成に失敗しました: " + error.message);
      dlBtn.style.display = "inline-block";
      dlBtn.onclick = () => {
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = "qrcode.png";
        a.click();
      };
    });
  </script>
</body>
</html>
``
